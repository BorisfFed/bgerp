= Плагин Mobile
:toc:

Плагин предоставляет возможность интеграции системы с мобильным приложением 
link:https://play.google.com/store/apps/details?id=ru.bgcrm[BGERP] для платформы Android.

Функционал приложения:
[square]
* вывод текущего количества непрочитанных новостей и необработанных сообщений;
* вывод счётчиков из очередей процессов, вынесенных пользователем на панель задач BGERP;
* получение Push сообщений из системы BGERP, хранение истории сообщений;
* отображение <<../../kernel/interface.adoc#mobile, мобильных очередей процессов>>.    

Мобильное приложение производит обмен данными только непосредственно с серверами BGERP клиентов. 
Централизовано только хранение реестра этих серверов, доступного для выбора пользователя.

== Настройка
Обращение к серверу BGERP происходит через <<../../kernel/interface.adoc#, открытый и мобильные интерфейсы>>. 
Необходимо убедиться, что они доступны из внешней сети. 
В качестве тестового URL можно использовать, например: *<HOST>/open/plugin/mobile/auth.do* В ответ сервер должен ответить JSON документом.

Для добавления сервера в список доступных в приложении необходимо выслать на bgerpp@gmail.com письмо с указанием вашего адреса открытого интерфейса BGERP. 
В ответ предоставляется уникальный ключ сервера. Его требуется указать в конфигурации сервера:

[source]
----
mobile:serverId=<ваш ключ>
----

Ваш сервер должен быть доступен в списке выбора мобильного приложения в списке серверов.

image::_res/mobile_login.png[width="300px"]

Для авторизации может быть использован логин и пароль любого пользователя BGERP.

//TODO: Скрин с сообщениями и очередью процессов.

== Использование

image::_res/mobile_screen.png[width="300px"]

Счётчики процессов, выводимые в статусе и их цвета идентичны определённым для отображения на панели задач BGERP.

Пользователю BGERP с установленным мобильным клиентом возможна отправка сообщений с помощью скрипта в 
doExpression <<../../kernel/process/processing.adoc#, простого обработчика событий>> возможна отправка сообщений.

[source]
----
onProcessEvent.1.events=statusChanged
onProcessEvent.1.doExpression=<<END
  text = process.getDescription();
  mobile.sendMessageToExecutors("Изменился статус процесса, в котором вы исполнитель", text);
END
#
onProcessEvent.2.events=messageAdded
onProcessEvent.2.doExpression=<<END
  text ="<b>Описание</b>: " + process.getDescription() + " Сообщение: " + event.getMessage().getText();
  mobile.sendMessageToExecutors("Новое сообщение в процессе, в котором вы исполнитель", text);
END
----

Объект mobile класса  javadoc:ru.bgcrm.plugin.mobile.DefaultProcessorFunctions[] с функциями API предоставляется плагином.

Сообщение приходят как PUSH уведомления и доступны к просмотру после в мобильном приложении.

image::_res/mobile_message.png[width="300px"]

Так же есть возможность отображать мобильную очередь процессов.

image::_res/mobile_process.png[width="300px"]
