= Плагин FullText
:toc:

При полнотекстовом поиске выполняется поиск по текстовому отображению параметров объекта. Например, адреса представляются в виде названия улиц, городов. 
Списковые параметры - расшифрованные значения. При каждом изменении параметров индекс обновляется и предоставляет выполнять поиск как: "Ленина 5 Иванов".

image::_res/search_fulltext.png[]

[[config]]
== Конфигурация
В конфигурации BGERP добавить:
----
fulltext:index.delay=<delay>
fulltext:entry.customer.paramIds=<paramIds>
fulltext:entry.process.paramIds=<paramIds>
fulltext:entry.message.paramIds=*
----
Где:
[square]
* *<delay>* - задержка в секундах индексации после окончании правки объекта;
* *<paramIds>* - коды параметров контрагента либо процессов, доступные для индексации, `*` - все параметры.

В полнотекстовый индекс помимо параметров для контрагента добавляется его наименование, для процесса - описание.
Обрабатываются следующие типы параметров:
[square]
* <<../../kernel/setup.adoc#param-text, text>>, <<../../kernel/setup.adoc#param-blob, blob>> - значения;
* <<../../kernel/setup.adoc#param-email, email>> - значения и комментарии;
* <<../../kernel/setup.adoc#param-list, list>>, <<../../kernel/setup.adoc#param-listcount, listcount>>, <<../../kernel/setup.adoc#param-tree, tree>> - наименования значений;
* <<../../kernel/setup.adoc#param-address, address>> - строка с адресом;
* <<../../kernel/setup.adoc#param-phone, phone>> - телефон сплошной строкой цифр.

При правильной настройке в оснастке <<../../kernel/search.adoc#, поиска>> появится ещё один выпадающий пункт *Полнотекстовый поиск*, см. снимок экрана ранее.

В <<../../kernel/setup.adoc#scheduler, планировщике задач>> добавить запуск класса *ru.bgcrm.plugin.fulltext.FullTextUpdater* 
либо выполнять его в период тестирования как <<../../kernel/extension.adoc#run, динамический класс>>.

=== SQL запросы для запуска первичной индексации
После отладки корректности индексации изменённых объектов с помощью следующих запросов можно запустить реиндексацию всех объектов. 
[source, sql]
----
INSERT INTO fulltext_data (object_type, object_id, scheduled_dt) SELECT 'customer', c.id, NOW() FROM customer AS c LEFT JOIN fulltext_data AS fd ON fd.object_type='customer' AND c.id=fd.object_id WHERE fd.object_id IS NULL;
INSERT INTO fulltext_data (object_type, object_id, scheduled_dt) SELECT 'process', p.id, NOW() FROM process AS p LEFT JOIN fulltext_data AS fd ON fd.object_type='process' AND p.id=fd.object_id WHERE fd.object_id IS NULL;
INSERT INTO fulltext_data (object_type, object_id, scheduled_dt) SELECT 'message', m.id, NOW() FROM n_message AS m LEFT JOIN fulltext_data AS fd ON fd.object_type='message' AND m.id=fd.object_id WHERE m.process_id>0 AND fd.object_id IS NULL;
----

== Формат запроса
По-умолчанию поиск ищет по условию логическое *ИЛИ* для всех введённых слов, разделённых пробелами.
Для добавления слова как *И* необходимо сопроводить его префиксом *+*.

Поиск производится в режиме *BOOLEAN* следующим запросом:
[source]
----
SELECT * FROM fulltext_data WHERE MATCH(ft.data) AGAINST ("СТРОКА ПОИСКА" IN BOOLEAN MODE)
----

Спецификацию для MySQL можно посмотреть здесь: https://dev.mysql.com/doc/refman/5.7/en/fulltext-boolean.html
