C: Large refactoring, extracting two action classes from too overloaded ProcessAction.
